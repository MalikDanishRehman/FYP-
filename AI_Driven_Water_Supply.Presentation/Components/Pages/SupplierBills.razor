@page "/supplier-bills"
@using AI_Driven_Water_Supply.Presentation
@using Supabase.Postgrest.Models
@using Supabase.Postgrest.Attributes
@inject Supabase.Client _supabase
@inject NavigationManager Nav
@inject AI_Driven_Water_Supply.Application.Interfaces.IAuthService AuthService
@inject AI_Driven_Water_Supply.Presentation.Services.ToastService ToastService

<style>
    .custom-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 2000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .custom-modal {
        background: #1a1a1a;
        padding: 25px;
        border-radius: 16px;
        width: 90%;
        max-width: 350px;
        text-align: center;
        border: 1px solid #333;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .btn-mode {
        width: 100%;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: 0.2s;
    }

    .btn-cash {
        background: #2ecc71;
        color: black;
    }

    .btn-jazz {
        background: #e74c3c;
        color: white;
    }

    .btn-cancel {
        background: #333;
        color: white;
        margin-top: 10px;
    }

    .clickable-card {
        cursor: pointer;
        transition: 0.2s;
    }

        .clickable-card:active {
            transform: scale(0.98);
        }
</style>

<div class="glass-nav">
    <div class="d-flex align-items-center gap-3">
        <i class="fa-solid fa-arrow-left back-btn" @onclick="GoBack"></i>
        <div class="brand-logo">Earnings & Bills</div>
    </div>
    <div><i class="fa-solid fa-wallet fs-4 text-earn"></i></div>
</div>

<div class="container-bills">

    <div class="summary-grid">
        <div class="summary-card">
            <div class="summary-label">Total Earnings</div>
            <div class="summary-val text-earn">Rs @TotalEarnings</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Pending Payments</div>
            <div class="summary-val text-pending">Rs @PendingAmount</div>
        </div>
    </div>

    <div class="section-title">Pending Collections</div>
    <small class="text-muted d-block mb-3">Tap on a bill to receive payment.</small>

    @if (isLoading)
    {
        <div class="text-center mt-5"><div class="spinner-border text-success"></div></div>
    }
    else if (collections.Count == 0)
    {
        <p class="text-center text-muted py-3">All payments collected.</p>
    }
    else
    {
        @foreach (var bill in collections)
        {
            <div class="bill-card clickable-card" @onclick="() => OpenPaymentModal(bill)">
                <div class="bill-info">
                    <div class="bill-icon"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                    <div class="bill-details">
                        <h6>Consumer: @bill.ConsumerName</h6>
                        <p>Order #@bill.OrderId • @bill.CreatedAt.ToLocalTime().ToString("dd MMM")</p>
                    </div>
                </div>
                <div class="bill-action">
                    <span class="bill-amount">Rs @bill.Amount</span>
                    <span class="status-badge status-due mb-2">Collect Payment</span>
                </div>
            </div>
        }
    }

    <div class="section-title mt-5">Recent Transactions (Received)</div>
    @foreach (var bill in history)
    {
        <div class="bill-card" style="opacity: 0.8;">
            <div class="bill-info">
                <div class="bill-icon" style="color: #24FE41;"><i class="fa-solid fa-sack-dollar"></i></div>
                <div class="bill-details">
                    <h6>Consumer: @bill.ConsumerName</h6>
                    <p>
                        Order #@bill.OrderId
                        <br /><span style="font-size:0.8rem; color:#aaa;">Via: @(bill.PaymentMethod ?? "Unknown")</span>
                    </p>
                </div>
            </div>
            <div class="bill-action">
                <span class="bill-amount text-muted">Rs @bill.Amount</span>
                <span class="status-badge status-received">Received</span>
            </div>
        </div>
    }
</div>

@if (showModal && selectedBill != null)
{
    <div class="custom-modal-overlay">
        <div class="custom-modal fade-in">
            <h4 class="text-white mb-1">Receive Payment?</h4>
            <p class="text-muted mb-4">Amount: <strong class="text-white">Rs @selectedBill.Amount</strong><br />Consumer: @selectedBill.ConsumerName</p>

            <button class="btn-mode btn-cash" @onclick='() => ProcessPayment("Cash")'>
                <i class="fa-solid fa-money-bill-wave"></i> Cash Received
            </button>

            <button class="btn-mode btn-jazz" @onclick='() => ProcessPayment("JazzCash")'>
                <i class="fa-solid fa-mobile-screen"></i> JazzCash / EasyPaisa
            </button>

            <button class="btn-mode btn-cancel" @onclick="CloseModal">Cancel</button>
        </div>
    </div>
}

  @code {
    // 👇 MODEL 
    [Table("bills")]
    public class Bill : BaseModel
    {
        [Column("id")] public int Id { get; set; }
        [Column("order_id")] public int OrderId { get; set; }
        [Column("consumer_name")] public string ConsumerName { get; set; } = "";
        [Column("supplier_name")] public string SupplierName { get; set; } = "";
        
        [Column("amount")] public float Amount { get; set; } // Float to avoid casting errors

        [Column("status")] public string Status { get; set; } = ""; // "Unpaid" or "Paid"
        [Column("created_at")] public DateTime CreatedAt { get; set; }
        [Column("payment_method")] public string? PaymentMethod { get; set; }
    }

    List<Bill> collections = new();
    List<Bill> history = new();

    float TotalEarnings = 0;
    float PendingAmount = 0;
    string MyName = "";
    bool isLoading = true;

    // Modal State
    bool showModal = false;
    Bill? selectedBill = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadProfileAndData();
    }

    async Task LoadProfileAndData()
    {
        try
        {
            var user = AuthService.CurrentUser;
            if (user != null)
            {
                // User ka naam fetch kar rahe hain taaki usi ke bills dikhein
                MyName = user.UserMetadata.ContainsKey("full_name")
                          ? user.UserMetadata["full_name"].ToString()
                          : "M.Akmal"; // Fallback
            }
            await LoadBills();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }

    async Task LoadBills()
    {
        // 👇 Yahan filter "MyName" se laga diya hai taaki sirf logged-in supplier ka data aaye
        var response = await _supabase.From<Bill>()
            .Where(x => x.SupplierName == MyName) 
            .Order("created_at", Supabase.Postgrest.Constants.Ordering.Descending)
            .Get();

        var allBills = response.Models;

        // 👇 Yahi MAGIC hai: Jo "Paid" ho gaya wo History me, jo "Unpaid" hai wo Collections me
        collections = allBills.Where(b => b.Status == "Unpaid").ToList();
        history = allBills.Where(b => b.Status == "Paid").ToList();

        // Totals calculate karna
        TotalEarnings = history.Sum(x => x.Amount);
        PendingAmount = collections.Sum(x => x.Amount);

        StateHasChanged();
    }

    void OpenPaymentModal(Bill bill)
    {
        selectedBill = bill;
        showModal = true;
    }

    void CloseModal()
    {
        showModal = false;
        selectedBill = null;
    }

    // 👇 MAIN FUNCTION: Ye Status ko "Paid" karega
    async Task ProcessPayment(string method)
    {
        if (selectedBill == null) return;

        try
        {
            // 1. Database Update
            await _supabase.From<Bill>()
                .Where(x => x.Id == selectedBill.Id)
                .Set(x => x.Status, "Paid")          // Status change
                .Set(x => x.PaymentMethod, method)   // Cash or JazzCash
                .Update();

            // 2. Success Message
            ToastService.ShowToast("Success", $"Payment received via {method}", "success");
            
            // 3. Modal Band
            CloseModal();

            // 4. UI Refresh (Taaki list update ho jaye aur bill neeche shift ho jaye)
            await LoadBills();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Payment Error: " + ex.Message);
            ToastService.ShowToast("Error", "Failed to update payment", "error");
        }
    }

    void GoBack() => Nav.NavigateTo("/ProviderDashboard");
}