@page "/login"
@using System.ComponentModel.DataAnnotations
@using AI_Driven_Water_Supply.Application.Interfaces
@inject IAuthService AuthService
@inject NavigationManager Nav

@* 👇 YEH DO (2) CHEEZEIN SABSE ZAROORI HAIN *@
@rendermode InteractiveServer

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
    .signup-container {
        background: #141622;
        color: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0px 4px 20px #0005;
        max-width: 400px;
        margin: 2rem auto;
    }

    .brand-green {
        color: #BFFF27;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.8rem;
        border-radius: 6px;
        border: 1px solid #222;
        background: #232638;
        color: #fff;
        font-size: 1rem;
    }

        .form-control:focus {
            background: #232638;
            color: #fff;
            border-color: #BFFF27;
            box-shadow: 0 0 5px rgba(191, 255, 39, 0.5);
        }

    .signup-btn {
        background: #BFFF27;
        color: #111;
        border: none;
        border-radius: 6px;
        padding: 0.8rem 2rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
        width: 100%;
    }

        .signup-btn:hover {
            background: #ddff70;
        }

    label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    .validation-message {
        color: #ff6b6b; /* Red color for errors is better visible */
        font-size: 0.9rem;
        margin-top: 5px;
        display: block;
    }
</style>

@* 👇 Note: 'FormName' add kiya hai yahan *@
<EditForm Model="@loginModel" OnValidSubmit="HandleLogin" FormName="LoginForm">
    <DataAnnotationsValidator />

    <div class="signup-container">
        <h2 class="text-center mb-4"><span class="brand-green">Login</span> to Smart Water</h2>

        <div class="form-group">
            <label>Email</label>
            <InputText @bind-Value="loginModel.Email" class="form-control" type="email" placeholder="Enter email" />
            <ValidationMessage For="@(() => loginModel.Email)" />
        </div>

        <div class="form-group">
            <label>Password</label>
            <InputText @bind-Value="loginModel.Password" class="form-control" type="password" placeholder="Enter password" />
            <ValidationMessage For="@(() => loginModel.Password)" />
        </div>

        <button type="submit" class="signup-btn" disabled="@isLoading">
            @if (isLoading)
            {
                <span>Processing...</span>
            }
            else
            {
                <span>Login</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger mt-3">@errorMessage</div>
        }
    </div>
</EditForm>

@code {
    [SupplyParameterFromForm]
    private LoginModel loginModel { get; set; } = new();

    private string errorMessage = "";
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = "";

        // Thoda delay taake user ko processing feel ho
        await Task.Delay(500);

        bool isLoggedIn = await AuthService.SignIn(loginModel.Email, loginModel.Password);

        if (isLoggedIn)
        {
            Nav.NavigateTo("/dashboard");
        }
        else
        {
            errorMessage = "Invalid email or password";
        }

        isLoading = false;
    }

    public class LoginModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email address")]
        public string Email { get; set; } = "";

        [Required(ErrorMessage = "Password is required")]
        public string Password { get; set; } = "";
    }
}