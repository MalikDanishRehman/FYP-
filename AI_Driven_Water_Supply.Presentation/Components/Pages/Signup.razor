@page "/signup"
@using System.ComponentModel.DataAnnotations
@using AI_Driven_Water_Supply.Application.Interfaces
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

@* 👇 Is line ko mat bhoolna *@
@rendermode InteractiveServer

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Signup.razor.css */

    .darker-border-checkbox.form-check-input {
        border-color: #929292;
    }

    .signup-container {
        background: #141622;
        color: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0px 4px 20px #0005;
        max-width: 400px;
        margin: 2rem auto;
    }

    .brand-green {
        color: #BFFF27;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.8rem;
        border-radius: 6px;
        border: 1px solid #222;
        background: #232638;
        color: #fff;
        font-size: 1rem;
    }

        .form-control:focus {
            background: #232638;
            color: #fff;
            border-color: #BFFF27;
            box-shadow: 0 0 5px rgba(191, 255, 39, 0.5);
        }

    .signup-btn {
        background: #BFFF27;
        color: #111;
        border: none;
        border-radius: 6px;
        padding: 0.8rem 2rem;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
        width: 100%;
    }

        .signup-btn:hover:not(:disabled) {
            background: #ddff70;
        }

        .signup-btn:disabled {
            background: #667744;
            cursor: not-allowed;
        }

    label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    /* Validation Errors Styling */
    .validation-message {
        color: #ff6b6b;
        font-size: 0.85rem;
        margin-top: 5px;
        display: block;
    }

    .alert-custom {
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        font-size: 0.9rem;
    }

    .alert-success-custom {
        background: rgba(191, 255, 39, 0.2);
        color: #BFFF27;
        border: 1px solid #BFFF27;
    }

    .alert-error-custom {
        background: rgba(255, 107, 107, 0.2);
        color: #ff6b6b;
        border: 1px solid #ff6b6b;
    }</style>
<div class="container">
    <EditForm Model="@signupModel" OnValidSubmit="HandleSignup" FormName="SignupForm">
        <DataAnnotationsValidator />

        <div class="signup-container">
            <h2 class="text-center mb-4"><span class="brand-green">Signup</span> for Smart Water</h2>

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="@(isSuccess ? "alert-custom alert-success-custom" : "alert-custom alert-error-custom")">
                    @message
                </div>
            }

            <div class="form-group">
                <label>Username</label>
                <InputText @bind-Value="signupModel.Username" class="form-control" placeholder="Enter username" />
                <ValidationMessage For="@(() => signupModel.Username)" />
            </div>

            <div class="form-group">
                <label>Email</label>
                <InputText @bind-Value="signupModel.Email" class="form-control" type="email" placeholder="name@example.com" />
                <ValidationMessage For="@(() => signupModel.Email)" />
            </div>

            <div class="form-group">
                <label>Password</label>
                <InputText @bind-Value="signupModel.Password" class="form-control" type="password" placeholder="••••••••" />
                <ValidationMessage For="@(() => signupModel.Password)" />
            </div>

            <button type="submit" class="signup-btn" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> Processing...</span>
                }
                else
                {
                    <span>Create Account</span>
                }
            </button>

            <div class="text-center mt-3">
                <small style="color: #aaa;">Already have an account? <a href="/login" class="brand-green" style="text-decoration: none;">Login</a></small>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [SupplyParameterFromForm]
    private SignupModel signupModel { get; set; } = new();

    private string message = "";
    private bool isSuccess = false;
    private bool isLoading = false;

    private async Task HandleSignup()
    {
        isLoading = true;
        message = "";

        await Task.Delay(500); // UI Effect

        // Tumhara Auth Service call
        bool result = await AuthService.SignUp(signupModel.Email, signupModel.Password, signupModel.Username);

        if (result)
        {
            isSuccess = true;
            message = "✅ Account created successfully! Redirecting...";
            StateHasChanged(); // UI Update force karo

            await Task.Delay(1500);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            isSuccess = false;
            message = "❌ Signup failed. Email might be taken.";
        }

        isLoading = false;
    }

    public class SignupModel
    {
        [Required(ErrorMessage = "Username is required")]
        public string Username { get; set; } = string.Empty;

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Invalid email format")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [MinLength(6, ErrorMessage = "Password must be at least 6 characters")]
        public string Password { get; set; } = string.Empty;
    }
}