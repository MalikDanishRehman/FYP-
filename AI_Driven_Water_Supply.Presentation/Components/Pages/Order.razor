@page "/order/{type}"

<div class="container mt-4">
    <div class="row">

        <!-- LEFT IMAGE -->
        <div class="col-md-4 d-flex align-items-start">
            <img src="/images/@($"{type}.jpg")"
                 alt="@type"
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;" />
        </div>

        <!-- RIGHT PANEL -->
        <div class="col-md-8">

            <h3 class="mb-3 text-white text-decoration-underline">Nearby Water Suppliers</h3>

            <!-- MAP AREA -->
            <div id="map" style="height:350px; width:100%; border-radius:10px; margin-bottom: 30px;"></div>

            <hr class="my-4" />

            <h3 class="mb-3 text-white text-decoration-underline">Available Suppliers List</h3>

            <div class="row g-3">

                @if (filteredSuppliers.Count == 0)
                {
                    <p class="text-danger">No suppliers found for: @type</p>
                }

                @foreach (var supplier in filteredSuppliers)
                {
                    <div class="col-md-4">
                        <div class="card shadow-sm">
                            <img src="https://via.placeholder.com/300x180"
                                 class="card-img-top" alt="">
                            <div class="card-body text-center">
                                <h5 class="card-title">@supplier.name</h5>
                                <p class="card-text">@supplier.description</p>
                                <button class="btn btn-primary btn-sm">Order Now</button>
                            </div>
                        </div>
                    </div>
                }

            </div>

        </div>
    </div>
</div>

@code {

    // -------- INJECT JS -------- //
    [Inject] IJSRuntime JS { get; set; }

    // -------- PAGE PARAMETER -------- //
    [Parameter] public string? type { get; set; }

    // -------- SUPPLIER MODEL -------- //
    public record Supplier(string name, double lat, double lng, string description);

    // -------- ALL SUPPLIERS -------- //
    List<Supplier> allSuppliers = new()
    {
        new Supplier("Fresh Aqua", 24.8610, 67.0011, "Fast delivery"),
        new Supplier("Pure RO Plant", 24.8620, 67.0022, "Premium RO Water"),
        new Supplier("Blue Tanker Service", 24.8585, 67.0065, "Same-day delivery")
    };

    // -------- FILTERED LIST -------- //
    List<Supplier> filteredSuppliers = new();


    // -----------------------------------------------------
    // 1️⃣ CORRECT PLACE: Handle route parameter changes
    // -----------------------------------------------------
    protected override void OnParametersSet()
    {
        FilterSuppliers();   // Set filtered list
    }


    // -----------------------------------------------------
    // 2️⃣ Load Google Map AFTER first render
    // -----------------------------------------------------
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("mapFunctions.loadMap", type, filteredSuppliers);
        }
    }


    // -----------------------------------------------------
    // 3️⃣ FILTERING BASED ON "type"
    // -----------------------------------------------------
    void FilterSuppliers()
    {
        if (string.IsNullOrWhiteSpace(type))
        {
            filteredSuppliers = new();
            return;
        }

        switch (type.ToLower())
        {
            case "bottle":
                filteredSuppliers = allSuppliers
                    .Where(s => s.name.Contains("Aqua"))
                    .ToList();
                break;

            case "plant":
                filteredSuppliers = allSuppliers
                    .Where(s => s.name.Contains("RO"))
                    .ToList();
                break;

            case "tanker":
                filteredSuppliers = allSuppliers
                    .Where(s => s.name.Contains("Tanker"))
                    .ToList();
                break;

            default:
                filteredSuppliers = new();
                break;
        }
    }
}
