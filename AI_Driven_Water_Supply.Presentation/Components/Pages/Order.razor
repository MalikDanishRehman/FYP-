@page "/order/{type}"
@using Supabase.Postgrest.Attributes @* Ye zaroori hai table mapping ke liye *@
@using Supabase.Postgrest.Models @* Ye bhi zaroori hai *@
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject Supabase.Client SupabaseClient
@* ✅ Supabase Client Inject kiya (Comment agli line par hona chahiye) *@
<div class="container mt-4">
    <div class="row">

        <div class="col-md-4 d-flex align-items-start">
            <img src="/images/@($"{type?.ToLower() ?? "default"}.jpg")"
                 alt="@type"
                 onerror="this.src='https://via.placeholder.com/300x400';"
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 70px;" />
        </div>

        <div class="col-md-8">
            <h3 class="mb-3 text-white text-decoration-underline">Nearby Water Suppliers</h3>
            
            <div id="map" style="height:350px; width:100%; border-radius:10px; margin-bottom: 30px; background-color: #ddd;"></div>

            <hr class="my-4" />

            <h3 class="mb-3 text-white text-decoration-underline">Available Suppliers List</h3>

            <div class="row g-3 mb-4">
                @if (isLoading)
                {
                     <p class="text-white">Loading suppliers from database...</p>
                }
                else if (filteredSuppliers.Count == 0)
                {
                    <p class="text-danger">No suppliers found for: @type</p>
                }

                @foreach (var supplier in filteredSuppliers)
                {
                    <div class="col-md-4">
                        <div class="card shadow-sm bg-body">
                            <img src="https://via.placeholder.com/300x180" class="card-img-top" alt="@supplier.name">

                            <div class="card-body text-center">
                                <h5 class="card-title text-white">@supplier.name</h5>

                                <p class="card-text text-warning" style="font-size:20px;">
                                    @GetStars(supplier.rating)
                                </p>

                                <button @onclick="() => GoToDetails(supplier.name)"
                                        class="btn btn-primary btn-sm">
                                    Order Now
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@code {
    [Parameter] public string? type { get; set; }

    // ✅ UI ke liye record (waisa hi rakha hai)
    public record Supplier(string name, double lat, double lng, double rating);
    
    // ✅ Supabase Table Model (Jo tumhare screenshot me hai)
    [Table("profiles")]
    public class Profile : BaseModel
    {
        [PrimaryKey("id")]
        public string Id { get; set; } = default!; // ✅ Default value de di

        [Column("username")]
        public string Username { get; set; } = string.Empty; // ✅ Empty string se initialize kar diya

        [Column("role")]
        public string Role { get; set; } = string.Empty; // ✅ Empty string se initialize kar diya
    }
    List<Supplier> allSuppliers = new();
    List<Supplier> filteredSuppliers = new();
    bool isLoading = true;

    // ✅ Jab page load hoga, tab Supabase se data ayega
    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // 1. Supabase se wo log uthao jinka Role 'Provider' hai
            var response = await SupabaseClient.From<Profile>()
                                     .Where(x => x.Role == "Provider") 
                                     .Get();

            var dbProfiles = response.Models;

            // 2. Data ko UI format (Supplier) mein convert karo
            // Note: Kyunki DB me lat/lng nahi hai, mene abhi dummy numbers dale hain.
            // Baad me tum DB me lat/lng columns bana lena.
            
            allSuppliers = dbProfiles.Select(p => new Supplier(
                p.Username, 
                24.8600 + (new Random().NextDouble() * 0.01), // Dummy Lat
                67.0000 + (new Random().NextDouble() * 0.01), // Dummy Lng
                4.5 // Default Rating
            )).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error fetching data: " + ex.Message);
        }
        finally
        {
            isLoading = false;
            FilterSuppliers(); // Data ane ke baad filter chalao
        }
    }

    // Parameters change hone par filter dobara chalana
    protected override void OnParametersSet()
    {
        FilterSuppliers();
    }

    // Map Load logic
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading && filteredSuppliers.Any()) 
        {
            try
            {
                await JS.InvokeVoidAsync("mapFunctions.loadMap", type, filteredSuppliers);
            }
            catch { /* Ignore JS errors if map not ready */ }
        }
    }

    string GetStars(double rating)
    {
        int fullStars = (int)Math.Floor(rating);
        bool halfStar = rating - fullStars >= 0.5;
        string stars = new string('★', fullStars);
        if (halfStar) stars += "½";
        return stars;
    }

    void FilterSuppliers()
    {
        if (allSuppliers == null || !allSuppliers.Any()) return;

        var t = type?.Trim().ToLower() ?? "";

        // Agar DB me naam "M.Akmal" hai aur tum "Tanker" search karoge to shayad match na ho.
        // Isliye abhi ke liye mene logic thodi easy kardi hai taake kuch to dikhe.
        
        filteredSuppliers = t switch
        {
            // Abhi ke liye sab dikha raha hun taake tum test kar sako.
            // Baad mein tum DB me 'service_type' column daal kar filter karna.
            _ => allSuppliers 
        };
    }

    void GoToDetails(string supplierName)
    {
        Nav.NavigateTo($"/supplier/{Uri.EscapeDataString(supplierName)}");
    }
}