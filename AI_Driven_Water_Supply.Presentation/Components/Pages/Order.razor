@page "/order/{type}"

<div class="container mt-4">
    <div class="row">

        <!-- LEFT IMAGE -->
        <div class="col-md-4 d-flex align-items-start">
            <img src="/images/@($"{type?.ToLower()}.jpg")"
                 alt="@type"
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 70px;" />
        </div>

        <!-- RIGHT PANEL -->
        <div class="col-md-8">

            <h3 class="mb-3 text-white text-decoration-underline">Nearby Water Suppliers</h3>

            <!-- MAP AREA -->
            <div id="map" style="height:350px; width:100%; border-radius:10px; margin-bottom: 30px;"></div>

            <hr class="my-4" />

            <h3 class="mb-3 text-white text-decoration-underline">Available Suppliers List</h3>

            <div class="row g-3 mb-4">

                @if (filteredSuppliers.Count == 0)
                {
                    <p class="text-danger">No suppliers found for: @type</p>
                }

                @foreach (var supplier in filteredSuppliers)
                {
                    <div class="col-md-4">
                        <div class="card shadow-sm bg-body">
                            <img src="https://via.placeholder.com/300x180" class="card-img-top" alt="">

                            <div class="card-body text-center">
                                <h5 class="card-title text-white">@supplier.name</h5>

                                <!-- ⭐ STAR RATING -->
                                <p class="card-text text-warning" style="font-size:20px;">
                                    @GetStars(supplier.rating)
                                </p>

                                <button class="btn btn-primary btn-sm"
                                        @onclick="() => GoToDetails(supplier.name)">
                                    Order Now
                                </button>

                            </div>
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@code {
    [Inject] IJSRuntime JS { get; set; } = default!;
    [Inject] NavigationManager Nav { get; set; } = default!;

    [Parameter] public string? type { get; set; }

    // Supplier Model
    public record Supplier(string name, double lat, double lng, double rating);

    // All suppliers
    List<Supplier> allSuppliers = new()
    {
        new Supplier("Fresh Aqua", 24.8610, 67.0011, 4.5),
        new Supplier("AquaFina", 24.8610, 67.0011, 2),
        new Supplier("Purify Aqua", 24.8610, 67.0011, 3),
        new Supplier("Pure RO Plant", 24.8620, 67.0022, 5),
        new Supplier("Water Plant", 24.8620, 67.0022, 1.5),
        new Supplier("Blue Tanker Service", 24.8585, 67.0065, 2)
    };

    List<Supplier> filteredSuppliers = new();

    protected override void OnParametersSet()
    {
        FilterSuppliers();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("mapFunctions.loadMap", type, filteredSuppliers);
        }
    }

    // ⭐ Star Generator
    string GetStars(double rating)
    {
        int fullStars = (int)Math.Floor(rating);
        bool halfStar = rating - fullStars >= 0.5;

        string stars = new string('★', fullStars);
        if (halfStar) stars += "½";

        return stars;
    }

    // Filtering Logic (case-insensitive)
    void FilterSuppliers()
    {
        var t = type?.Trim().ToLower() ?? "";

        filteredSuppliers = t switch
        {
            "bottle" => allSuppliers.Where(s => s.name.ToLower().Contains("aqua")).ToList(),
            "plant" => allSuppliers.Where(s => s.name.ToLower().Contains("plant")).ToList(),
            "tanker" => allSuppliers.Where(s => s.name.ToLower().Contains("tanker")).ToList(),
            _ => new List<Supplier>()
        };
    }

    void GoToDetails(string supplierName)
    {
        Nav.NavigateTo($"/supplier/{Uri.EscapeDataString(supplierName)}");
    }

}
