@page "/order/{type}"
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="container mt-4">
    <div class="row">

        <div class="col-md-4 d-flex align-items-start">
            <img src="/images/@($"{type?.ToLower() ?? "default"}.jpg")"
                 alt="@type"
                 onerror="this.src='https://via.placeholder.com/300x400';"
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 70px;" />
        </div>

        <div class="col-md-8">

            <h3 class="mb-3 text-white text-decoration-underline">Nearby Water Suppliers</h3>

            <div id="map" style="height:350px; width:100%; border-radius:10px; margin-bottom: 30px; background-color: #ddd;"></div>

            <hr class="my-4" />

            <h3 class="mb-3 text-white text-decoration-underline">Available Suppliers List</h3>

            <div class="row g-3 mb-4">

                @if (filteredSuppliers.Count == 0)
                {
                    <p class="text-danger">No suppliers found for: @type</p>
                }

                @foreach (var supplier in filteredSuppliers)
                {
                    <div class="col-md-4">
                        <div class="card shadow-sm bg-body">
                            <img src="https://via.placeholder.com/300x180" class="card-img-top" alt="@supplier.name">

                            <div class="card-body text-center">
                                <h5 class="card-title text-white">@supplier.name</h5>

                                <p class="card-text text-warning" style="font-size:20px;">
                                    @GetStars(supplier.rating)
                                </p>

                                <a href="/supplier/@Uri.EscapeDataString(supplier.name)"
                                   class="btn btn-primary btn-sm">
                                    Order Now
                                </a>

                            </div>
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@code {
    [Parameter] public string? type { get; set; }

    public record Supplier(string name, double lat, double lng, double rating);

    List<Supplier> allSuppliers = new()
    {
        new Supplier("Fresh Aqua", 24.8610, 67.0011, 4.5),
        new Supplier("AquaFina", 24.8610, 67.0011, 2),
        new Supplier("Purify Aqua", 24.8610, 67.0011, 3),
        new Supplier("Pure RO Plant", 24.8620, 67.0022, 5),
        new Supplier("Water Plant", 24.8620, 67.0022, 1.5),
        new Supplier("Blue Tanker Service", 24.8585, 67.0065, 2)
    };

    List<Supplier> filteredSuppliers = new();

    protected override void OnParametersSet()
    {
        FilterSuppliers();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Map load karne ki koshish (agar JS function ready hai)
                await JS.InvokeVoidAsync("mapFunctions.loadMap", type, filteredSuppliers);
            }
            catch
            {
                // Agar map JS file missing hai to error ignore karega
            }
        }
    }

    string GetStars(double rating)
    {
        int fullStars = (int)Math.Floor(rating);
        bool halfStar = rating - fullStars >= 0.5;
        string stars = new string('★', fullStars);
        if (halfStar) stars += "½";
        return stars;
    }

    void FilterSuppliers()
    {
        var t = type?.Trim().ToLower() ?? "";

        filteredSuppliers = t switch
        {
            "bottle" => allSuppliers.Where(s => s.name.ToLower().Contains("aqua")).ToList(),
            "plant" => allSuppliers.Where(s => s.name.ToLower().Contains("plant")).ToList(),
            "tanker" => allSuppliers.Where(s => s.name.ToLower().Contains("tanker")).ToList(),
            _ => allSuppliers
        };
    }

    // ✅ MAIN FUNCTION JO NAVIGATE KAREGA
    void GoToDetails(string supplierName)
    {
        // Space wale naam (jaise Fresh Aqua) ko safe URL banata hai
        Nav.NavigateTo($"/supplier/{Uri.EscapeDataString(supplierName)}");
    }
}