@page "/order/{type}"

<div class="container mt-4">
    <div class="row">

        <!-- LEFT IMAGE -->
        <div class="col-md-4 d-flex align-items-start">
            <img src="/images/@($"{type}.jpg")"
                 alt="@type"
                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 70px;" />
        </div>

        <!-- RIGHT PANEL -->
        <div class="col-md-8">

            <h3 class="mb-3 text-white text-decoration-underline">Nearby Water Suppliers</h3>

            <!-- MAP AREA -->
            <div id="map" style="height:350px; width:100%; border-radius:10px; margin-bottom: 30px;"></div>

            <hr class="my-4" />

            <h3 class="mb-3 text-white text-decoration-underline">Available Suppliers List</h3>

            <div class="row g-3 mb-4">

                @if (filteredSuppliers.Count == 0)
                {
                    <p class="text-danger">No suppliers found for: @type</p>
                }

                @foreach (var supplier in filteredSuppliers)
                {
                    <div class="col-md-4">
                        <div class="card shadow-sm bg-body">
                            <img src="https://via.placeholder.com/300x180"
                                 class="card-img-top" alt="">

                            <div class="card-body text-center">
                                <h5 class="card-title text-white">@supplier.name</h5>

                                <!-- ⭐ STAR RATING HERE -->
                                <p class="card-text text-warning" style="font-size:20px;">
                                    @GetStars(supplier.rating)
                                </p>

                                <button class="btn btn-primary btn-sm">Order Now</button>
                            </div>
                        </div>
                    </div>
                }

            </div>

        </div>
    </div>
</div>

@code {

    [Inject] IJSRuntime JS { get; set; }

    [Parameter] public string? type { get; set; }

    // Updated Supplier Model (⭐ rating added)
    public record Supplier(string name, double lat, double lng, double rating);

    // Suppliers List with Ratings
    List<Supplier> allSuppliers = new()
    {
        new Supplier("Fresh Aqua", 24.8610, 67.0011, 4.5),
        new Supplier("AquaFina", 24.8610, 67.0011, 2),
        new Supplier("Purify Aqua", 24.8610, 67.0011, 3),
        new Supplier("Pure RO Plant", 24.8620, 67.0022, 5),
         new Supplier("Water Plant", 24.8620, 67.0022, 1.5),
        new Supplier("Blue Tanker Service", 24.8585, 67.0065, 2)
    };

    List<Supplier> filteredSuppliers = new();

    protected override void OnParametersSet()
    {
        FilterSuppliers();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("mapFunctions.loadMap", type, filteredSuppliers);
        }
    }

    // ⭐ Star Generator Function
    string GetStars(double rating)
    {
        int fullStars = (int)Math.Floor(rating);
        bool halfStar = rating - fullStars >= 0.5;

        string output = new string('★', fullStars);

        if (halfStar)
            output += "½";

        return output;
    }

    // Filtering Logic
    void FilterSuppliers()
    {
        if (string.IsNullOrWhiteSpace(type))
        {
            filteredSuppliers = new();
            return;
        }

        switch (type.ToLower())
        {
            case "bottle":
                filteredSuppliers = allSuppliers
                    .Where(s => s.name.Contains("Aqua"))
                    .ToList();
                break;

            case "plant":
                filteredSuppliers = allSuppliers
                    .Where(s => s.name.Contains("Plant"))
                    .ToList();
                break;

            case "tanker":
                filteredSuppliers = allSuppliers
                    .Where(s => s.name.Contains("Tanker"))
                    .ToList();
                break;

            default:
                filteredSuppliers = new();
                break;
        }
    }
}
