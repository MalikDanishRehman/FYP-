@page "/chat/{OrderId:long}"
@using AI_Driven_Water_Supply.Presentation
@using Supabase.Postgrest.Models
@inject Supabase.Client _supabase
@inject NavigationManager Nav
@inject AI_Driven_Water_Supply.Application.Interfaces.IAuthService AuthService
@rendermode InteractiveServer

<style>
    /* Chat Styling */
    .chat-container { max-width: 800px; margin: 0 auto; height: 85vh; display: flex; flex-direction: column; background: #171a2b; border-radius: 15px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .chat-header { padding: 15px; background: #1f233a; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; color: white; }
    .chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background-color: #0b0d17; }
    .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 15px; color: white; position: relative; font-size: 0.95rem; }
    .sent { align-self: flex-end; background-color: #BFFF27; color: black; border-bottom-right-radius: 2px; }
    .received { align-self: flex-start; background-color: #2c3e50; border-bottom-left-radius: 2px; }
    .system-msg { align-self: center; background-color: rgba(255,255,255,0.1); color: #ccc; font-size: 0.8rem; padding: 5px 15px; border-radius: 20px; margin: 10px 0; border: 1px solid rgba(255,255,255,0.1); }
    .chat-footer { padding: 15px; background: #1f233a; display: flex; gap: 10px; }
    .time-stamp { font-size: 0.7rem; opacity: 0.7; display: block; margin-top: 5px; text-align: right; }

    /* STATUS BUTTONS */
    .status-btn-group { display: flex; gap: 5px; }
    .btn-xs { font-size: 0.75rem; padding: 5px 10px; font-weight: bold; border-radius: 20px; }
</style>

<div class="container mt-4">
    <button class="btn btn-outline-light mb-2" @onclick="GoBack">
        <i class="fa-solid fa-arrow-left"></i> Back
    </button>

    <div class="chat-container shadow-lg">

        <div class="chat-header">
            <div>
                <h5 class="m-0 fw-bold"><i class="fa-solid fa-user-circle me-2"></i> @DisplayChatName</h5>
                <small class="text-muted">Order ID: #@OrderId | @ItemName</small>
            </div>

            <div class="d-flex align-items-center gap-3">
                <span class="badge @GetStatusColor(OrderStatus) text-dark px-3 py-2">@OrderStatus</span>

                @if (AmISupplier && OrderStatus != "Completed" && OrderStatus != "Cancelled")
                {
                    <div class="status-btn-group">
                        @if (OrderStatus == "Pending")
                        {
                            <button class="btn btn-success btn-xs" @onclick='() => UpdateStatus("Accepted")'>Accept</button>
                            <button class="btn btn-danger btn-xs" @onclick='() => UpdateStatus("Cancelled")'>Reject</button>
                        }
                        else if (OrderStatus == "Accepted")
                        {
                            <button class="btn btn-warning btn-xs" @onclick='() => UpdateStatus("Out for Delivery")'>Dispatch 🚚</button>
                        }
                        else if (OrderStatus == "Out for Delivery")
                        {
                            <button class="btn btn-info btn-xs" @onclick='() => UpdateStatus("Completed")'>Complete ✅</button>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="chat-body">
            @if (isLoading)
            {
                <div class="text-center text-white mt-5"><div class="spinner-border text-success"></div></div>
            }
            else if (messages.Count == 0)
            {
                <div class="text-center text-muted mt-5">No messages yet.</div>
            }
            else
            {
                @foreach (var msg in messages)
                {
                    @if (msg.SenderName == "System")
                    {
                        <div class="system-msg">@msg.Content</div>
                    }
                    else
                    {
                        <div class="message-bubble @(msg.SenderName == MyName ? "sent" : "received")">
                            <strong>@(msg.SenderName == MyName ? "You" : msg.SenderName)</strong> <br />
                            @msg.Content
                            <span class="time-stamp">@msg.CreatedAt.ToString("hh:mm tt")</span>
                        </div>
                    }
                }
            }
        </div>

        <div class="chat-footer">
            <input type="text" class="form-control bg-dark text-white border-secondary"
                   placeholder="Type a message..."
                   @bind="newMessageInput"
                   @onkeyup="@(e => { if (e.Key == "Enter") SendMessage(); })" />

            <button class="btn btn-success fw-bold" @onclick="SendMessage">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>

    </div>
</div>

@code {
    [Parameter] public long OrderId { get; set; }

    private string MyName = "";
    private string SupplierName = "";
    private string ConsumerName = "";
    private string DisplayChatName = "Loading..."; // Chat header name
    private string ItemName = "";
    private string OrderStatus = "";
    private string newMessageInput = "";
    private bool isLoading = true;
    private bool AmISupplier = false; // Check karega ke main Supplier hun ya Customer

    private List<AI_Driven_Water_Supply.Presentation.Message> messages = new();

    protected override async Task OnInitializedAsync()
    {
        // 1. Identify User
        var user = AuthService.CurrentUser;
        if (user != null && user.UserMetadata.TryGetValue("username", out var nameObj))
        {
            MyName = nameObj?.ToString() ?? "";
        }
        else
        {
            MyName = "Unknown"; // Fallback
        }

        await LoadOrderDetails();
        await LoadMessages();
    }

    private async Task LoadOrderDetails()
    {
        try
        {
            var response = await _supabase.From<AI_Driven_Water_Supply.Presentation.Order>()
                                          .Where(x => x.Id == OrderId)
                                          .Get();
            var order = response.Models.FirstOrDefault();

            if (order != null)
            {
                ConsumerName = order.ConsumerName;
                SupplierName = order.SupplierName;
                ItemName = $"{order.Quantity}x {order.ItemName}";
                OrderStatus = order.Status;

                // Check Role: Agar mera naam Supplier se match kare, to main Supplier hun
                if (MyName == SupplierName)
                {
                    AmISupplier = true;
                    DisplayChatName = ConsumerName; // Supplier ko Consumer ka naam dikhega
                }
                else
                {
                    AmISupplier = false;
                    DisplayChatName = SupplierName; // Consumer ko Supplier ka naam dikhega
                }
            }
        }
        catch (Exception ex) { Console.WriteLine("Error: " + ex.Message); }
    }

    private async Task LoadMessages()
    {
        isLoading = true;
        try
        {
            var response = await _supabase.From<AI_Driven_Water_Supply.Presentation.Message>()
                                          .Where(x => x.OrderId == OrderId)
                                          .Order("created_at", Supabase.Postgrest.Constants.Ordering.Ascending)
                                          .Get();
            messages = response.Models;
        }
        finally { isLoading = false; }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessageInput)) return;
        var content = newMessageInput;
        newMessageInput = "";
        await PostMessage(MyName, AmISupplier ? ConsumerName : SupplierName, content);
    }

    // Helper to insert message
    private async Task PostMessage(string sender, string receiver, string content)
    {
        var newMsg = new AI_Driven_Water_Supply.Presentation.Message
        {
            OrderId = OrderId,
            SenderName = sender,
            ReceiverName = receiver,
            Content = content,
            CreatedAt = DateTime.UtcNow
        };
        messages.Add(newMsg); // UI Update
        await _supabase.From<AI_Driven_Water_Supply.Presentation.Message>().Insert(newMsg);
    }

    // 🔥 STATUS CHANGE LOGIC
    private async Task UpdateStatus(string newStatus)
    {
        try
        {
            // 1. Update Database Status
            await _supabase.From<AI_Driven_Water_Supply.Presentation.Order>()
                           .Where(x => x.Id == OrderId)
                           .Set(x => x.Status, newStatus)
                           .Update();

            OrderStatus = newStatus; // Update UI Badge

            // 2. Auto-Send System Message into Chat
            string systemMsg = "";
            if (newStatus == "Accepted") systemMsg = $"✅ Order Accepted by {SupplierName}. Preparing delivery.";
            else if (newStatus == "Out for Delivery") systemMsg = $"🚚 Order is Out for Delivery! See you soon.";
            else if (newStatus == "Completed") systemMsg = $"🎉 Order Delivered Successfully. Thank you!";
            else if (newStatus == "Cancelled") systemMsg = $"❌ Order was Cancelled by Provider.";

            await PostMessage("System", ConsumerName, systemMsg);
        }
        catch (Exception ex) { Console.WriteLine("Status Update Error: " + ex.Message); }
    }

    private string GetStatusColor(string status) => status switch
    {
        "Pending" => "bg-warning",
        "Accepted" => "bg-info",
        "Out for Delivery" => "bg-primary",
        "Completed" => "bg-success",
        "Cancelled" => "bg-danger",
        _ => "bg-secondary"
    };

    void GoBack() => Nav.NavigateTo(AmISupplier ? "/ProviderDashboard" : "/Consumer");
}