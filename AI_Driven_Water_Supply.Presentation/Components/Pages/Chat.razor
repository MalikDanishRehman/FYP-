@page "/chat/{OrderId:long}"
@using AI_Driven_Water_Supply.Presentation
@using Supabase.Postgrest.Models
@inject Supabase.Client _supabase
@inject NavigationManager Nav
@inject AI_Driven_Water_Supply.Application.Interfaces.IAuthService AuthService
@inject IJSRuntime JS
@rendermode InteractiveServer

<style>
    /* ... (Styles Same as before) ... */
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: 85vh;
        display: flex;
        flex-direction: column;
        background: #171a2b;
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .chat-header {
        padding: 15px;
        background: #1f233a;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
    }

    .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background-color: #0b0d17;
    }

    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
        color: white;
        position: relative;
        font-size: 0.95rem;
    }

    .sent {
        align-self: flex-end;
        background-color: #BFFF27;
        color: black;
        border-bottom-right-radius: 2px;
    }

    .received {
        align-self: flex-start;
        background-color: #2c3e50;
        border-bottom-left-radius: 2px;
    }

    .system-msg {
        align-self: center;
        background-color: rgba(255,255,255,0.1);
        color: #ccc;
        font-size: 0.8rem;
        padding: 5px 15px;
        border-radius: 20px;
        margin: 10px 0;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .chat-footer {
        padding: 15px;
        background: #1f233a;
        display: flex;
        gap: 10px;
    }

    .time-stamp {
        font-size: 0.7rem;
        opacity: 0.7;
        display: block;
        margin-top: 5px;
        text-align: right;
    }

    .status-btn-group {
        display: flex;
        gap: 5px;
    }

    .btn-xs {
        font-size: 0.75rem;
        padding: 5px 10px;
        font-weight: bold;
        border-radius: 20px;
    }
</style>

<div class="container mt-4">
    <button class="btn btn-outline-light mb-2" @onclick="GoBack">
        <i class="fa-solid fa-arrow-left"></i> Back
    </button>

    <div class="chat-container shadow-lg">

        <div class="chat-header">
            <div>
                <h5 class="m-0 fw-bold"><i class="fa-solid fa-user-circle me-2"></i> @DisplayChatName</h5>
                <small class="text-muted">Order ID: #@OrderId | @ItemName</small>
            </div>

            <div class="d-flex align-items-center gap-3">
                <span class="badge @GetStatusColor(OrderStatus) text-dark px-3 py-2">@OrderStatus</span>

                @if (AmISupplier && OrderStatus != "Completed" && OrderStatus != "Cancelled")
                {
                    <div class="status-btn-group">
                        @if (OrderStatus == "Pending")
                        {
                            <button class="btn btn-success btn-xs" @onclick='() => UpdateStatus("Accepted")'>Accept</button>
                            <button class="btn btn-danger btn-xs" @onclick='() => UpdateStatus("Cancelled")'>Reject</button>
                        }
                        else if (OrderStatus == "Accepted")
                        {
                            <button class="btn btn-warning btn-xs" @onclick='() => UpdateStatus("Out for Delivery")'>Dispatch 🚚</button>
                        }
                        else if (OrderStatus == "Out for Delivery")
                        {
                            <button class="btn btn-info btn-xs" @onclick='() => UpdateStatus("Completed")'>Complete ✅</button>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="chat-body">
            @if (isLoading)
            {
                <div class="text-center text-white mt-5"><div class="spinner-border text-success"></div></div>
            }
            else if (messages.Count == 0)
            {
                <div class="text-center text-muted mt-5">No messages yet.</div>
            }
            else
            {
                @foreach (var msg in messages)
                {
                    @if (msg.SenderName == "System")
                    {
                        <div class="system-msg">@msg.Content</div>
                    }
                    else
                    {
                        <div class="message-bubble @(msg.SenderName == MyName ? "sent" : "received")">
                            <strong>@(msg.SenderName == MyName ? "You" : msg.SenderName)</strong> <br />
                            @msg.Content
                            <span class="time-stamp">@msg.CreatedAt.ToLocalTime().ToString("hh:mm tt")</span>
                        </div>
                    }
                }
            }
        </div>

        <div class="chat-footer">
            <input type="text" class="form-control bg-dark text-white border-secondary"
                   placeholder="Type a message..."
                   @bind="newMessageInput"
                   @onkeyup="@(e => { if (e.Key == "Enter") SendMessage(); })" />

            <button class="btn btn-success fw-bold" @onclick="SendMessage">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>

    </div>
</div>

@code {
    [Parameter] public long OrderId { get; set; }

    private string MyName = "";
    private string SupplierName = "";
    private string ConsumerName = "";
    private string DisplayChatName = "Loading...";
    private string ItemName = "";
    private string OrderStatus = "";
    private string newMessageInput = "";
    private bool isLoading = true;
    private bool AmISupplier = false;

    private List<AI_Driven_Water_Supply.Presentation.Message> messages = new();

    // Fix: CS8618 (Initialized properties)
    [Supabase.Postgrest.Attributes.Table("profiles")]
    public class Profile : Supabase.Postgrest.Models.BaseModel
    {
        [Supabase.Postgrest.Attributes.Column("id")]
        public string Id { get; set; } = string.Empty;

        [Supabase.Postgrest.Attributes.Column("username")]
        public string Username { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        var user = AuthService.CurrentUser;
        if (user == null)
        {
            await AuthService.TryRefreshSession();
            user = AuthService.CurrentUser;
        }

        if (user != null)
        {
            string fetchedName = "";
            try
            {
                var response = await _supabase.From<Profile>().Where(x => x.Id == user.Id).Get();
                var profile = response.Models.FirstOrDefault();
                // Fix: CS8601 (Null assignment check)
                if (profile != null) fetchedName = profile.Username ?? "";
            }
            catch { }

            if (string.IsNullOrEmpty(fetchedName) && user.UserMetadata != null)
                if (user.UserMetadata.TryGetValue("username", out var nameObj))
                    fetchedName = nameObj?.ToString() ?? ""; // Fix: Null coalescing

            // Fix: CS8602 (Possible null email)
            string email = user.Email ?? "";
            if (string.IsNullOrEmpty(fetchedName) && !string.IsNullOrEmpty(email))
                fetchedName = email.Split('@')[0];

            MyName = fetchedName;
        }
        else
        {
            Nav.NavigateTo("/login");
            return;
        }

        await LoadOrderDetails();
        await LoadMessages();
    }

    private async Task LoadOrderDetails()
    {
        try
        {
            var response = await _supabase.From<AI_Driven_Water_Supply.Presentation.Order>()
                                          .Where(x => x.Id == OrderId)
                                          .Get();
            var order = response.Models.FirstOrDefault();

            if (order != null)
            {
                ConsumerName = order.ConsumerName;
                SupplierName = order.SupplierName;
                ItemName = $"{order.Quantity}x {order.ItemName}";
                OrderStatus = order.Status;

                if (string.Equals(MyName, SupplierName, StringComparison.OrdinalIgnoreCase))
                {
                    AmISupplier = true;
                    DisplayChatName = ConsumerName;
                }
                else
                {
                    AmISupplier = false;
                    DisplayChatName = SupplierName;
                }
            }
        }
        catch (Exception ex) { Console.WriteLine("Error: " + ex.Message); }
    }

    private async Task LoadMessages()
    {
        isLoading = true;
        try
        {
            var response = await _supabase.From<AI_Driven_Water_Supply.Presentation.Message>()
                                          .Where(x => x.OrderId == OrderId)
                                          .Order("created_at", Supabase.Postgrest.Constants.Ordering.Ascending)
                                          .Get();
            messages = response.Models;
        }
        finally { isLoading = false; }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessageInput)) return;
        var content = newMessageInput;
        newMessageInput = "";
        await PostMessage(MyName, AmISupplier ? ConsumerName : SupplierName, content);
    }

    private async Task PostMessage(string sender, string receiver, string content)
    {
        var newMsg = new AI_Driven_Water_Supply.Presentation.Message
        {
            OrderId = OrderId,
            SenderName = sender,
            ReceiverName = receiver,
            Content = content,
            CreatedAt = DateTime.UtcNow
        };
        messages.Add(newMsg);
        await _supabase.From<AI_Driven_Water_Supply.Presentation.Message>().Insert(newMsg);
    }

    private async Task UpdateStatus(string newStatus)
    {
        try
        {
            await _supabase.From<AI_Driven_Water_Supply.Presentation.Order>()
                           .Where(x => x.Id == OrderId)
                           .Set(x => x.Status, newStatus)
                           .Update();

            OrderStatus = newStatus;

            if (newStatus == "Accepted")
            {
                var ordResponse = await _supabase.From<AI_Driven_Water_Supply.Presentation.Order>()
                                                 .Where(x => x.Id == OrderId).Get();
                var orderData = ordResponse.Models.FirstOrDefault();

                if (orderData != null)
                {
                    var newBill = new Bill
                    {
                        OrderId = OrderId,
                        ConsumerName = ConsumerName,
                        SupplierName = SupplierName,
                        Amount = (decimal)orderData.TotalPrice,
                        Status = "Unpaid",
                        CreatedAt = DateTime.UtcNow
                    };
                    await _supabase.From<Bill>().Insert(newBill);
                }
            }

            string systemMsg = "";
            if (newStatus == "Accepted") systemMsg = $"✅ Order Accepted by {SupplierName}. Bill Generated.";
            else if (newStatus == "Out for Delivery") systemMsg = $"🚚 Order is Out for Delivery!";
            else if (newStatus == "Completed") systemMsg = $"🎉 Order Delivered Successfully.";
            else if (newStatus == "Cancelled") systemMsg = $"❌ Order was Cancelled by Provider.";

            // Fix: CS4014 - Await added here
            await PostMessage("System", ConsumerName, systemMsg);
        }
        catch (Exception ex) { Console.WriteLine("Status Update Error: " + ex.Message); }
    }

    private string GetStatusColor(string status) => status switch
    {
        "Pending" => "bg-warning",
        "Accepted" => "bg-info",
        "Out for Delivery" => "bg-primary",
        "Completed" => "bg-success",
        "Cancelled" => "bg-danger",
        "Paid" => "bg-success",
        _ => "bg-secondary"
    };

    void GoBack()
    {
        Nav.NavigateTo(AmISupplier ? "/ProviderDashboard" : "/Consumer");
    }
}