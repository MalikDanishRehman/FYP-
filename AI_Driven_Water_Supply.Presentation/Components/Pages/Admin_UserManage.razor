@page "/UserManagement"
@using AI_Driven_Water_Supply.Application.Interfaces
@using AI_Driven_Water_Supply.Application.Models
@using Supabase.Postgrest.Models
@inject Supabase.Client _supabase
@inject IAuthService AuthService
@inject NavigationManager Nav
@rendermode InteractiveServer
@layout AdminSidebar

<style>
    /* --- Page Header & Search --- */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .header-title h2 {
        font-size: 2rem;
        font-weight: 800;
        color: white;
        margin: 0;
    }

    .header-title span {
        color: #BFFF27;
    }

    .actions-wrapper {
        display: flex;
        gap: 15px;
    }

    .search-wrapper {
        position: relative;
        width: 300px;
        max-width: 100%;
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
    }

    .custom-input {
        width: 100%;
        background: #0f0f12;
        border: 1px solid #1f1f1f;
        padding: 12px 15px 12px 45px;
        border-radius: 8px;
        color: white;
        outline: none;
        transition: 0.3s;
        box-sizing: border-box; /* Ensures padding doesn't affect width */
    }

        .custom-input:focus {
            border-color: #BFFF27;
            box-shadow: 0 0 10px rgba(191, 255, 39, 0.1);
        }

    .btn-add {
        background: #BFFF27;
        color: black;
        border: none;
        padding: 0 20px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: 0.3s;
    }

        .btn-add:hover {
            background: white;
            box-shadow: 0 0 15px rgba(191, 255, 39, 0.4);
        }

    /* --- Mini Stats Cards --- */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: #0f0f12;
        border: 1px solid #1f1f1f;
        padding: 20px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.3s;
    }

        .stat-card:hover {
            border-color: #333;
            transform: translateY(-2px);
        }

    .stat-info p {
        margin: 0;
        color: #888;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-info h3 {
        margin: 5px 0 0 0;
        color: white;
        font-size: 1.8rem;
        font-weight: 700;
    }

    .stat-icon {
        width: 45px;
        height: 45px;
        background: rgba(255,255,255,0.03);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    /* --- Table Styles --- */
    .table-card {
        background: #0f0f12;
        border: 1px solid #1f1f1f;
        border-radius: 12px;
        padding: 20px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
    }

    .custom-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px; /* Forces table to scroll on mobile */
    }

        .custom-table th {
            text-align: left;
            color: #666;
            font-size: 0.85rem;
            text-transform: uppercase;
            padding: 15px;
            border-bottom: 1px solid #1f1f1f;
            letter-spacing: 0.5px;
            white-space: nowrap; /* Prevents text wrap */
        }

        .custom-table td {
            padding: 15px;
            border-bottom: 1px solid #1f1f1f;
            color: #ddd;
            vertical-align: middle;
            white-space: nowrap; /* Prevents text wrap */
        }

        .custom-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

    /* User Profile */
    .user-profile {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #BFFF27, #2ecc71);
        color: black;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        box-shadow: 0 2px 10px rgba(191, 255, 39, 0.2);
        flex-shrink: 0;
    }

    .user-info h4 {
        margin: 0;
        color: white;
        font-size: 0.95rem;
    }

    .user-info small {
        color: #888;
        font-size: 0.8rem;
    }

    /* Badges */
    .badge {
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }

    .badge-admin {
        background: rgba(155, 89, 182, 0.15);
        color: #9b59b6;
        border: 1px solid rgba(155, 89, 182, 0.3);
    }

    .badge-customer {
        background: rgba(52, 152, 219, 0.15);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
    }

    .status-active {
        color: #2ecc71;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
    }

    .status-banned {
        color: #e74c3c;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
    }

    /* Buttons */
    .action-group {
        display: flex;
        gap: 8px;
    }

    .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid #333;
        background: transparent;
        color: #888;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .btn-icon:hover {
            background: #1f1f1f;
            color: white;
            border-color: #666;
        }

    .btn-delete:hover {
        background: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
        border-color: #e74c3c;
    }

    /* === RESPONSIVE DESIGN === */
    @@media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .header-title h2 {
            font-size: 1.6rem;
        }

        .actions-wrapper {
            width: 100%;
            flex-direction: column; /* Stack search and button on mobile */
        }

        .search-wrapper {
            width: 100%;
        }

        .btn-add {
            width: 100%; /* Full width button on mobile */
            justify-content: center;
            padding: 12px 20px; /* Bigger touch area */
        }

        .table-card {
            padding: 10px;
        }
    }

</style>

<div class="page-header">
    <div class="header-title">
        <h2>User <span>Management</span></h2>
        <small style="color: #666;">Control customer access and roles</small>
    </div>

    <div class="actions-wrapper">
        <div class="search-wrapper">
            <i class="fa-solid fa-search search-icon"></i>
            <input type="text" class="custom-input" placeholder="Search users..." @bind="searchTerm" @bind:event="oninput">
        </div>
        <button class="btn-add">
            <i class="fa-solid fa-plus"></i> Add User
        </button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-info">
            <p>Total Users</p>
            <h3>@dummyUsers.Count</h3>
        </div>
        <div class="stat-icon" style="color: #fff;">
            <i class="fa-solid fa-users"></i>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-info">
            <p>Active Now</p>
            <h3>@dummyUsers.Count(u => u.Status == "Active")</h3>
        </div>
        <div class="stat-icon" style="color: #2ecc71;">
            <i class="fa-solid fa-circle-check"></i>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-info">
            <p>Banned</p>
            <h3>@dummyUsers.Count(u => u.Status == "Banned")</h3>
        </div>
        <div class="stat-icon" style="color: #e74c3c;">
            <i class="fa-solid fa-ban"></i>
        </div>
    </div>
</div>

<div class="table-card">
    <table class="custom-table">
        <thead>
            <tr>
                <th>User Details</th>
                <th>Role</th>
                <th>Status</th>
                <th>Joined Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in FilteredUsers)
            {
                <tr>
                    <td>
                        <div class="user-profile">
                            <div class="user-avatar">
                                @user.Name.Substring(0, 1).ToUpper()
                            </div>
                            <div class="user-info">
                                <h4>@user.Name</h4>
                                <small>@user.Email</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge @(user.Role == "Admin" ? "badge-admin" : "badge-customer")">
                            @user.Role
                        </span>
                    </td>
                    <td>
                        @if (user.Status == "Active")
                        {
                            <span class="status-active"><i class="fa-solid fa-circle" style="font-size:6px;"></i> Active</span>
                        }
                        else
                        {
                            <span class="status-banned"><i class="fa-solid fa-circle" style="font-size:6px;"></i> Banned</span>
                        }
                    </td>
                    <td style="color:#888;">@user.JoinDate</td>
                    <td>
                        <div class="action-group">
                            <button class="btn-icon" title="Edit User"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-icon btn-delete" title="Delete User"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    // Search Logic
    private string searchTerm = "";

    // Dummy Data Model
    public class UserViewModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Email { get; set; } = "";
        public string Role { get; set; } = "Customer";
        public string Status { get; set; } = "Active";
        public string JoinDate { get; set; } = "";
    }

    // Hardcoded List
    private List<UserViewModel> dummyUsers = new List<UserViewModel>
    {
        new UserViewModel { Id = 1, Name = "Ali Khan", Email = "ali.khan@gmail.com", Role = "Customer", Status = "Active", JoinDate = "10 Feb 2024" },
        new UserViewModel { Id = 2, Name = "Admin User", Email = "admin@system.com", Role = "Admin", Status = "Active", JoinDate = "01 Jan 2024" },
        new UserViewModel { Id = 3, Name = "Sara Ahmed", Email = "sara123@hotmail.com", Role = "Customer", Status = "Banned", JoinDate = "15 Mar 2024" },
        new UserViewModel { Id = 4, Name = "Bilal Raza", Email = "bilal.raza@yahoo.com", Role = "Customer", Status = "Active", JoinDate = "22 Mar 2024" },
        new UserViewModel { Id = 5, Name = "Zain Malik", Email = "zain.malik@gmail.com", Role = "Customer", Status = "Active", JoinDate = "05 Apr 2024" },
    };

    // Filter Logic
    private IEnumerable<UserViewModel> FilteredUsers =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? dummyUsers
            : dummyUsers.Where(u => u.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                    u.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
}