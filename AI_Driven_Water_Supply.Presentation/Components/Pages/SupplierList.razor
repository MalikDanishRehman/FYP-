@page "/order/{type}"
@using Supabase.Postgrest.Attributes
@using Supabase.Postgrest.Models
@inject Supabase.Client _supabase
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<style>
    :root {
        --glass-bg: rgba(30, 35, 45, 0.7);
        --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        --primary-glow: 0 0 15px rgba(0, 198, 255, 0.5);
    }

    body {
        background-color: #0f1216;
        color: white;
        font-family: 'Inter', sans-serif;
    }

    /* Map Styling */
    #map {
        height: 100%;
        min-height: 500px;
        width: 100%;
        border-radius: 16px;
        border: var(--glass-border);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        z-index: 1;
    }

    /* Card Styling */
    .supplier-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: var(--glass-border);
        border-radius: 12px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
    }

        .supplier-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--primary-glow);
            border-color: rgba(255, 255, 255, 0.3);
        }

    .card-img-wrapper {
        height: 160px;
        overflow: hidden;
        position: relative;
    }

        .card-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

    .supplier-card:hover .card-img-wrapper img {
        transform: scale(1.1);
    }

    .btn-glow {
        background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
        border: none;
        color: white;
        font-weight: 600;
        transition: 0.3s;
    }

        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(0, 198, 255, 0.6);
            color: white;
        }

    /* Scrollbar for list */
    .supplier-list-container {
        height: 80vh;
        overflow-y: auto;
        padding-right: 10px;
    }

        .supplier-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .supplier-list-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        .supplier-list-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
</style>

<div class="container-fluid px-4 py-4">
    <div class="row g-4">

        <div class="col-lg-5 col-xl-4 d-none d-lg-block">
            <div class="position-sticky" style="top: 20px;">
                <h4 class="mb-3 text-white fw-bold"><i class="bi bi-map-fill me-2 text-primary"></i>Live Suppliers</h4>
                <div id="map"></div>
            </div>
        </div>

        <div class="col-lg-7 col-xl-8">
            <div class="d-flex justify-content-between align-items-end mb-3">
                <div>
                    <h6 class="text-muted text-uppercase small m-0">Order Type</h6>
                    <h2 class="text-white fw-bold m-0 text-capitalize">@type Delivery</h2>
                </div>
                <button class="btn btn-outline-light btn-sm rounded-pill" @onclick='() => Nav.NavigateTo("/Consumer")'>
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>

            <div class="supplier-list-container">
                <div class="row g-3">
                    @if (isLoading)
                    {
                        <div class="col-12 text-center text-white mt-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 small">Locating Suppliers...</p>
                        </div>
                    }
                    else if (filteredSuppliers.Count == 0)
                    {
                        <div class="col-12 text-center text-danger mt-5">
                            <i class="bi bi-exclamation-circle display-4"></i>
                            <p class="mt-3">No active suppliers found in this category.</p>
                        </div>
                    }

                    @foreach (var supplier in filteredSuppliers)
                    {
                        <div class="col-md-6 col-xl-4">
                            <div class="card supplier-card h-100">
                                <div class="card-img-wrapper">
                                    <img src="@supplier.ImageUrl" onerror="this.src='/images/fallbackimg.jpg';">
                                    <div class="position-absolute top-0 end-0 m-2">
                                        <span class="badge bg-black bg-opacity-75 backdrop-blur">
                                            ⭐ @supplier.Rating.ToString("0.0")
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body p-3 text-center">
                                    <h5 class="card-title text-white fw-bold mb-1">@supplier.Name</h5>
                                    <p class="text-muted small mb-3">Verified Supplier</p>

                                    <button @onclick="() => GoToDetails(supplier.Name)" class="btn btn-glow w-100 rounded-3 py-2">
                                        Select Provider
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
@code {
    [Parameter] public string? type { get; set; }
    private bool isLoading = true;
    private List<SupplierViewModel> filteredSuppliers = new();

    // --- DB Model ---
    [Table("profiles")]
    public class SupplierProfile : BaseModel
    {
        [Column("id")] public string Id { get; set; } = "";
        [Column("username")] public string Username { get; set; } = "";
        [Column("role")] public string Role { get; set; } = "";
        [Column("rating")] public double Rating { get; set; }
        [Column("profilepic")] public string ProfilePic { get; set; } = "";
        // ✅ NEW: Services column DB se uthane ke liye
        [Column("services")] public string? Services { get; set; }
    }

    public class SupplierViewModel
    {
        public string Name { get; set; } = "";
        public double Rating { get; set; }
        public string ImageUrl { get; set; } = "";
        public double Lat { get; set; }
        public double Lng { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;

            // 1. Fetch Providers (Role = "Provider" wale saare le aao)
            var response = await _supabase.From<SupplierProfile>()
                                          .Where(x => x.Role == "Provider")
                                          .Get();

            filteredSuppliers.Clear();
            var rnd = new Random();

            foreach (var item in response.Models)
            {
                // ✅ LOGIC: Check karein agar supplier ki 'Services' mein current '{type}' maujood hai
                bool hasService = false;

                if (!string.IsNullOrEmpty(item.Services) && !string.IsNullOrEmpty(type))
                {
                    // "Bottles,Plant,Tanker" ko list me split karein aur exact type match karein
                    var providerServices = item.Services.Split(',').Select(s => s.Trim()).ToList();

                    if (providerServices.Contains(type, StringComparer.OrdinalIgnoreCase))
                    {
                        hasService = true;
                    }
                }

                // Agar service match hoti hai, tabhi usko UI ke list mein add karein
                if (hasService)
                {
                    string finalImageUrl = string.IsNullOrEmpty(item.ProfilePic)
                        ? "/images/fallbackimg.jpg"
                        : _supabase.Storage.From("Avatar").GetPublicUrl(item.ProfilePic);

                    filteredSuppliers.Add(new SupplierViewModel
                    {
                        Name = item.Username,
                        Rating = item.Rating,
                        ImageUrl = finalImageUrl,
                        Lat = 24.8607 + (rnd.NextDouble() * 0.1 - 0.05),
                        Lng = 67.0011 + (rnd.NextDouble() * 0.1 - 0.05)
                    });
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            // Secure Error Message
            // ToastService.ShowToast("Connection Error", "Unable to retrieve secure supplier list.", "error");
        }
        finally
        {
            // ✅ FIX: Data load hone ke baad loading spinner band karna zaroori hai
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || (filteredSuppliers.Count > 0 && !mapInitialized))
        {
            if (filteredSuppliers.Count > 0)
            {
                await JSRuntime.InvokeVoidAsync("initMap", filteredSuppliers);
                mapInitialized = true;
            }
        }
    }

    private bool mapInitialized = false;

    private void GoToDetails(string name) => Nav.NavigateTo($"/supplier/{name}");
}
<script>
    window.initMap = (suppliers) => {
        // Check if map container exists
        if (!document.getElementById('map')) return;

        // Check if map is already initialized to avoid error
        if (window.leafletMap) {
            window.leafletMap.remove();
        }

        // Initialize Map (Default view Karachi)
        var map = L.map('map').setView([24.8607, 67.0011], 12);
        window.leafletMap = map;

        // Dark Theme Map Tiles
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // Add Markers for each supplier
        suppliers.forEach(s => {
            var marker = L.marker([s.lat, s.lng]).addTo(map);

            // Custom Popup
            var popupContent = `
                <div style="text-align:center; color: black;">
                    <b>${s.name}</b><br>
                    ⭐ ${s.rating.toFixed(1)}
                </div>
            `;
            marker.bindPopup(popupContent);
        });
    }
</script>