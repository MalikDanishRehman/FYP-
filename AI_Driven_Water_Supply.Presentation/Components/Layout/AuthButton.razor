@using AI_Driven_Water_Supply.Application.Interfaces
@using Supabase.Gotrue
@inject IAuthService AuthService
@inject NavigationManager Nav
@implements IDisposable
@* 👆 IDisposable zaroori hai taake memory leak na ho *@

@rendermode InteractiveServer

@if (IsLoggedIn)
{
    <span class="text-light me-3 d-none d-md-block">
        Hello, <span class="text-success fw-bold">@UserName</span>
    </span>
    <button class="btn btn-danger btn-sm" @onclick="HandleLogout">
        <i class="bi bi-box-arrow-right"></i> Sign Out
    </button>
}
else
{
    <a href="/signup" class="btn btn-outline-light me-2">Sign Up</a>
    <a href="/login" class="btn btn-light">Sign In</a>
}

@code {
    private bool IsLoggedIn = false;
    private string UserName = "User";

    protected override void OnInitialized()
    {
        // 👇 Subscribe karo: Jab bhi auth change ho, CheckUserStatus chalao
        AuthService.OnChange += StateHasChanged;
        CheckUserStatus();
    }

    // 👇 Jab component band ho to unsubscribe karo
    public void Dispose()
    {
        AuthService.OnChange -= StateHasChanged;
    }

    // Yeh function har baar chalega jab StateHasChanged call hoga
    protected override void OnAfterRender(bool firstRender)
    {
        // State update check
        CheckUserStatus();
    }

    private void CheckUserStatus()
    {
        var user = AuthService.CurrentUser;
        if (user != null)
        {
            // Agar pehle false tha, tabhi update karo (Infinite loop se bachne ke liye)
            if (!IsLoggedIn)
            {
                IsLoggedIn = true;
                UserName = user.Email?.Split('@')[0] ?? "User";
                StateHasChanged(); // Refresh UI
            }
        }
        else
        {
            if (IsLoggedIn)
            {
                IsLoggedIn = false;
                StateHasChanged(); // Refresh UI
            }
        }
    }

    private async Task HandleLogout()
    {
        await AuthService.SignOut(); // Yeh khud notify karega
        Nav.NavigateTo("/login"); // ForceLoad ki zaroorat nahi
    }
}