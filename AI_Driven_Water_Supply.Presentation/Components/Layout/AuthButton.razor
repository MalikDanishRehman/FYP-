@using AI_Driven_Water_Supply.Application.Interfaces
@using Supabase.Gotrue
@inject IAuthService AuthService
@inject NavigationManager Nav
@implements IDisposable

@rendermode InteractiveServer

@if (IsLoggedIn)
{
    <span class="text-light me-3 d-none d-md-block">
        Hello, <span class="text-success fw-bold">@UserName</span>
    </span>

    <button class="btn btn-danger btn-sm" @onclick="HandleLogout">
        <i class="bi bi-box-arrow-right"></i> Sign Out
    </button>
}
else
{
    <div class="d-flex gap-2">
        <a href="login" class="btn  btn-outline-light">Login</a>

        <a href="get-started" class="btn btn-primary" style="background-color: #BFFF27; color: black; border: none;">
            Sign Up
        </a>
    </div>
}

@code {
    private bool IsLoggedIn = false;
    private string UserName = "User";

    // ✅ 1. Event Subscribe (Ye yahan safe hai)
    protected override void OnInitialized()
    {
        AuthService.OnChange += UpdateStatus;
    }

    // ✅ 2. FIX: Session Check yahan hoga (Browser connect hone ke baad)
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Ab JS Error nahi aayega kyunke Page Render ho chuka hai
                await AuthService.TryRefreshSession();
                UpdateStatus(); // UI update karo
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Auth Error: {ex.Message}");
                ToastService.ShowToast("Error Failed", "Something went wrong!", "error");
            }
        }
    }

    public void Dispose()
    {
        // Memory leak rokne ke liye unsubscribe
        AuthService.OnChange -= UpdateStatus;
    }

    private void UpdateStatus()
    {
        var user = AuthService.CurrentUser;

        if (user != null)
        {
            IsLoggedIn = true;

            // Username nikalne ka safe tareeqa
            if (user.UserMetadata != null && user.UserMetadata.TryGetValue("username", out var nameObj))
            {
                UserName = nameObj?.ToString() ?? user.Email ?? "User";
            }
            else
            {
                UserName = user.Email?.Split('@')[0] ?? "User";
            }
        }
        else
        {
            IsLoggedIn = false;
            UserName = "User";
        }

        // UI Refresh force karo
        InvokeAsync(StateHasChanged);
    }

    private async Task HandleLogout()
    {
        await AuthService.SignOut();
        // ForceLoad true rakha hai taake logout ke baad page poora refresh ho
        Nav.NavigateTo("/login", forceLoad: true);
    }
}